
{{- $page := . -}}
{{- $sections := slice -}}

{{- $themesDir := partial "poppy-engine/get_hugo_config" "themesDir" -}}
{{- $theme := partial "poppy-engine/get_hugo_config" "theme" }}

{{ if .Parent}}
  {{- $sections = .Params.page_sections | default .Parent.Params.subpage_sections -}}
{{ else }}
  {{- $sections = .Params.page_sections  -}}
{{ end }}

{{- range $sections -}}
    {{- $page_section := .}}
    {{- $page_component := site.GetPage (printf "page-components/%s" .page_component ) -}}

    {{ with $page_component }}
      {{- $poppy_component := printf "poppy-components/%s/%s" .Params.poppy_type .Params.poppy_variant -}}
      {{- if (fileExists (printf "%s/%s/layouts/partials/%s.html" $themesDir $theme $poppy_component )) }}
          {{- $content_info := partial "poppy-engine/get_content" (dict "page" $page "section" $page_section "page_component" . ) -}}
          {{- $design_info := partial "poppy-engine/get_design" . -}}

          {{- if site.Params.debug -}}
            {{- partial "poppy-engine/debug_component" (dict "page" $page "component" $page_component "poppy_component" $poppy_component "content_info" $content_info "design_info" $design_info ) -}}
          {{- end -}}

          {{- with $content_info.content -}}
            {{- partial "UI-elements/bg_image" (dict "page" .bg_resource_page "css_class" .bg_css "bg_image" .bg_image ) }}
          {{- end -}}
          {{- "<!-- {.File.ContentBaseName }} -->" | safeHTML -}}
          {{- partial $poppy_component (dict "page" $page "content" $content_info.content "design" $design_info.design  ) -}}
      {{- end -}}
    {{ end }}
{{- end -}}
